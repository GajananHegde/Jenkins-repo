upstream commercial_app_prod_us {
  server localhost:8092 fail_timeout=0;
}
limit_req_zone $binary_remote_addr zone=commercial_app_prod_us:10m rate=10r/s;

server {
  if ($request_method !~ ^(GET|POST|PUT|DELETE|OPTIONS)$) {
    return 444;
  }

  listen 80;

  ## Security headers for Nginx ##
  # add_header Strict-Transport-Security "max-age=15768000" always;
  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header X-Frame-Options "SAMEORIGIN" always;
  add_header X-Xss-Protection "1; mode=block" always;
  add_header Referrer-Policy strict-origin-when-cross-origin;
  add_header Feature-policy "accelerometer 'none'; camera 'none'; geolocation 'none'; gyroscope 'none'; magnetometer 'none'; microphone 'none'; payment 'none'; usb 'none'";

  add_header content-security-policy "base-uri 'self'; frame-ancestors 'self' https://www.youtube.com https://adservice.google.com https://ad.doubleclick.net https://gcptm.bmo.com https://gcptm.bmoharris.com https://www.google.ca https://youtu.be youtube.com https://player.vimeo.com https://gcptm.bmoharris.com https://googleadservices.com https://megaphone.fm/ https://playlist.megaphone.fm https://megaphone.link https://smetrics.bmo.com/ https://smetrics.bmo.com/*; img-src 'self' 'unsafe-inline' https://www.google.ca https://d2t1fx2jgbhsez.cloudfront.net https://dpm.demdex.net https://commercial.bmo.com https://www.googletagmanager.com https://bat.bing.com https://smetrics.bmo.com https://cm.everesttech.net https://dpm.demdex.net https://tags.bluekai.com https://ad.doubleclick.net https://idsync.rlcdn.com https://tapestry.tapad.com https://www.facebook.com https://www.google-analytics.com https://alb.reddit.com https://www.google.com https://adservice.google.com https://googleads.g.doubleclick.net/ https://smetrics.bmo.com/ https://smetrics.bmo.com/*; object-src 'none'; default-src 'self' blob: 'unsafe-inline' 'unsafe-eval' https://smetrics.bmo.com https://commercial.bmo.com https://www.google.com https://dpm.demdex.net youtube.com https://www.youtube.com https://adservice.google.com https://ad.doubleclick.net https://gcptm.bmo.com https://gcptm.bmoharris.com https://www.google.ca https://youtu.be https://player.vimeo.com https://gcptm.bmoharris.com https://googleadservices.com https://megaphone.fm/ https://playlist.megaphone.fm https://megaphone.link https://bankofmontreal.us-1.evergage.com doubleclick.net https://www.google-analytics.com https://bmofinancial.demdex.net https://d2t1fx2jgbhsez.cloudfront.net *.doubleclick.net https://smetrics.bmo.com/ https://smetrics.bmo.com/*; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://d2t1fx2jgbhsez.cloudfront.net https://capitalmarkets.bmo.com https://ajax.googleapis.com https://code.jquery.com https://cdnjs.cloudflare.com https://www.gstatic.com https://www.google.com/recaptcha/api.js https://connect.facebook.net https://www.google-analytics.com/analytics.js https://cdn.evgnet.com/beacon/bankofmontreal/engage/scripts/evergage.min.js https://bankofmontreal.us-1.evergage.com https://bat.bing.com https://www.googletagmanager.com https://www.youtube.com https://adservice.google.com https://ad.doubleclick.net https://gcptm.bmo.com https://gcptm.bmoharris.com https://www.google.ca https://youtu.be https://player.vimeo.com https://gcptm.bmoharris.com https://googleadservices.com https://megaphone.fm/ https://playlist.megaphone.fm https://megaphone.link https://bpi.briteverify.com https://api.demandbase.com https://vt.myvisualiq.net https://dpm.demdex.net https://tags.bluekai.com https://ad.doubleclick.net https://idsync.rlcdn.com https://tapestry.tapad.com https://www.facebook.com https://www.google-analytics.com *.doubleclick.net https://www.googleadservices.com https://www.mczbf.com https://*.taboola.com https://smetrics.bmo.com/ https://smetrics.bmo.com/*; connect-src 'self' *.google-analytics.com *.doubleclick.net https://adservice.google.com https://gcptm.bmo.com https://gcptm.bmoharris.com https://dpm.demdex.net https://bankofmontreal.us-1.evergage.com https://www.mczbf.com https://*.taboola.com https://www.sjwoe.com https://smetrics.bmo.com/ https://smetrics.bmo.com/*; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://d2t1fx2jgbhsez.cloudfront.net https://smetrics.bmo.com/ https://smetrics.bmo.com/*; font-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://d2t1fx2jgbhsez.cloudfront.net https://smetrics.bmo.com/ https://smetrics.bmo.com/*"  always;
#  add_header content-security-policy "base-uri 'self'; frame-ancestors 'self' https://www.youtube.com https://adservice.google.com https://gcptm.bmo.com https://www.google.ca https://youtu.be youtube.com https://player.vimeo.com https://gcptm.bmoharris.com https://googleadservices.com https://megaphone.fm/ https://playlist.megaphone.fm https://megaphone.link; img-src 'self' 'unsafe-inline' https://d2t1fx2jgbhsez.cloudfront.net https://dpm.demdex.net https://commercial.bmo.com https://commercial.bmo.com https://www.googletagmanager.com https://bat.bing.com https://smetrics.bmo.com https://cm.everesttech.net https://dpm.demdex.net https://tags.bluekai.com https://ad.doubleclick.net https://idsync.rlcdn.com https://tapestry.tapad.com https://www.facebook.com https://www.google-analytics.com; object-src 'none'; default-src 'self' blob: 'unsafe-inline' 'unsafe-eval' https://smetrics.bmo.com https://commercial.bmo.com  https://commercial.bmo.com https://www.google.com https://dpm.demdex.net youtube.com https://www.youtube.com https://adservice.google.com https://gcptm.bmo.com https://www.google.ca https://youtu.be https://player.vimeo.com https://gcptm.bmoharris.com https://googleadservices.com https://megaphone.fm/ https://playlist.megaphone.fm https://megaphone.link https://bankofmontreal.us-1.evergage.com doubleclick.net https://www.google-analytics.com https://bmofinancial.demdex.net https://d2t1fx2jgbhsez.cloudfront.net *.doubleclick.net; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://d2t1fx2jgbhsez.cloudfront.net https://capitalmarkets.bmo.com https://ajax.googleapis.com https://code.jquery.com https://cdnjs.cloudflare.com https://www.gstatic.com https://www.google.com/recaptcha/api.js https://connect.facebook.net https://www.google-analytics.com/analytics.js https://cdn.evgnet.com/beacon/bankofmontreal/engage/scripts/evergage.min.js https://bankofmontreal.us-1.evergage.com https://bat.bing.com https://www.googletagmanager.com https://www.youtube.com https://adservice.google.com https://gcptm.bmo.com https://www.google.ca https://youtu.be https://player.vimeo.com https://gcptm.bmoharris.com https://googleadservices.com https://megaphone.fm/ https://playlist.megaphone.fm https://megaphone.link https://bpi.briteverify.com https://api.demandbase.com https://vt.myvisualiq.net https://dpm.demdex.net https://tags.bluekai.com https://ad.doubleclick.net https://idsync.rlcdn.com https://tapestry.tapad.com https://www.facebook.com https://www.google-analytics.com *.doubleclick.net; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://d2t1fx2jgbhsez.cloudfront.net; connect-src 'self' *.google-analytics.com https://gcptm.bmo.com *.doubleclick.net https://adservice.google.com https://gcptm.bmoharris.com; font-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://d2t1fx2jgbhsez.cloudfront.net" always;

  server_name commercial.bmo.com www.commercial.bmo.com bmo-us-commercial-prod.galepartners.com;
  server_tokens off;
  charset utf-8;
  client_max_body_size 4G;
  keepalive_timeout 60;

  satisfy any;
  allow all;


  #  location /robots.txt { return 200 "User-agent: *\nDisallow: /\n"; }
  location = /mediaesfheartbeat.txt {
    add_header Content-Type text/plain;
    alias /application/django-media/mediaesfheartbeat.txt;
  }

  error_page 403 = @403;

  location @403 {
    include /etc/nginx/conf.d/uwsgi_params;
    uwsgi_pass commercial_app_prod_us;
  }

  location /static {
    access_log off;
    add_header 'Access-Control-Allow-Origin' '*';
    add_header Cache-Control "max-age=2592000";
    alias /application/django-assets;
    allow all;
  }

  location /media {
    access_log off;
    add_header Cache-Control "max-age=2592000";
    alias /application/django-media;
  }

  # prevent admin access in production
  rewrite ^(.*)?/admin/ / permanent;
  rewrite ^(.*)?/cms/ / permanent;

  rewrite ^(.*)?/admin$ / permanent;
  rewrite ^(.*)?/cms$ / permanent;

  ##
  rewrite ^\/(en)\/(resource)\/(.*)$ https://commercial.bmo.com/$1/ca/$2/$3 last;
  rewrite ^\/(en)\/(resources)\/(.*)$ https://commercial.bmo.com/$1/ca/$2/$3 last;
  rewrite ^\/(en)\/(industry-expertise)\/(.*)$ https://commercial.bmo.com/$1/ca/$2/$3 last;
  rewrite ^\/(en)\/(we-can-help)\/(.*)$ https://commercial.bmo.com/$1/ca/$2/$3 last;
  rewrite ^\/(en)\/(our-bankers)\/(.*)$ https://commercial.bmo.com/$1/ca/$2/$3 last;
  rewrite ^\/(en)\/(who-we-are)\/(.*)$ https://commercial.bmo.com/$1/ca/$2/$3 last;
  ##

  rewrite ^/media/filer_public/b8/32/b8327acd-b66b-4614-a94f-6f9e8dd9a61a/covid-19_economicresponse_ccb_final_fr_printable_20-0804.pdf /filer/sharing/1586275438/4860/ redirect;
  rewrite ^/media/filer_public/6c/e6/6ce66bc4-c71f-4a2f-96c6-1f426037000a/covid-19_economicresponse_ccb_final_eng_printable_20-0804.pd /filer/sharing/1586202205/4857/ redirect;
  
  #DHD-18372
  rewrite ^/realestate  /en/us/industry-expertise/commercial-real-estate/ permanent;
  rewrite ^/abl /en/us/we-can-help/asset-based-lending/ permanent;
  rewrite ^/afp /en/us/we-can-help/manage-cash-flow/ permanent;
  rewrite ^/ag  /en/us/industry-expertise/agriculture/ permanent;
  rewrite ^/agri  /en/us/industry-expertise/agriculture/ permanent;
  rewrite ^/agribusiness  /en/us/industry-expertise/agribusiness-protein/ permanent;
  rewrite ^/agriculture /en/us/industry-expertise/agriculture/ permanent;
  rewrite ^/autodealer  /en/us/industry-expertise/auto-dealerships/ permanent;
  rewrite ^/beverage  /en/us/industry-expertise/food/ permanent;
  rewrite ^/business-strategy /en/us/we-can-help/business-strategy/ permanent;
  rewrite ^/cardealer /en/us/industry-expertise/auto-dealerships/ permanent;
  rewrite ^/communitydevelopment  /en/us/industry-expertise/commercial-real-estate/ permanent;
  rewrite ^/construction  /en/us/industry-expertise/engineering-construction/ permanent;
  rewrite ^/convenience /en/us/industry-expertise/fuel-services/ permanent;
  rewrite ^/corporateadvisory /en/us/we-can-help/corporate-advisory/ permanent;
  rewrite ^/correspondent /en/us/industry-expertise/correspondent-banking/ permanent;
  rewrite ^/deposits  /en/us/we-can-help/manage-cash-flow/ permanent;
  rewrite ^/economicinsights  /en/us/we-can-help/economic-insights/ permanent;
  rewrite ^/education /en/us/industry-expertise/educational-institutions/ permanent;
  rewrite ^/equipmentfinance  /en/us/we-can-help/equipment-finance/ permanent;
  rewrite ^/financegrowth /en/us/we-can-help/finance-growth/ permanent;
  rewrite ^/financialadvisoryservices /en/us/we-can-help/corporate-advisory/ permanent;
  rewrite ^/food  /en/us/industry-expertise/food/ permanent;
  rewrite ^/foodretail  /en/us/industry-expertise/retail/ permanent;
  rewrite ^/franchisefinance  /en/us/industry-expertise/franchise/ permanent;
  rewrite ^/franchisefinancing  /en/us/industry-expertise/franchise/ permanent;
  rewrite ^/fuelservices  /en/us/industry-expertise/fuel-services/ permanent;
  rewrite ^/futures /en/us/industry-expertise/futures-securities/ permanent;
  rewrite ^/governments /en/us/industry-expertise/governments/ permanent;
  rewrite ^/healthcare  /en/us/industry-expertise/healthcare/ permanent;
  rewrite ^/healthcarebanking /en/us/industry-expertise/healthcare/ permanent;
  rewrite ^/healthcarefinance /en/us/industry-expertise/healthcare/ permanent;
  rewrite ^/international /en/us/we-can-help/doing-business-internationally/ permanent;
  rewrite ^/leasing /en/us/we-can-help/equipment-finance/ permanent;
  rewrite ^/ma  /en/us/we-can-help/mergers-acquisitions/ permanent;
  rewrite ^/managecash  /en/us/we-can-help/manage-cash-flow/ permanent;
  rewrite ^/manage-risk /en/us/we-can-help/manage-risk/ permanent;
  rewrite ^/manufacturing/ /en/us/industry-expertise/manufacturing/ permanent;
  rewrite ^/metals  /en/us/industry-expertise/metals/ permanent;
  rewrite ^/MidMarketMA /en/us/we-can-help/mergers-acquisitions/ permanent;
  rewrite ^/minoritybusinesses  /en/us/we-can-help/minority-owned-businesses/ permanent;
  rewrite ^/notforprofit  /en/us/industry-expertise/not-profit-organizations/ permanent;
  rewrite ^/professionalservices  /en/us/industry-expertise/professional-services/ permanent;
  rewrite ^/protein /en/us/industry-expertise/agribusiness-protein/ permanent;
  rewrite ^/retail  /en/us/industry-expertise/retail/ permanent;
  rewrite ^/schooldistricts /en/us/industry-expertise/educational-institutions/ permanent;
  rewrite ^/securities  /en/us/industry-expertise/futures-securities/ permanent;
  rewrite ^/specialtyfinance  /en/us/industry-expertise/specialty-finance/ permanent;
  rewrite ^/sponsorfinance  /en/us/industry-expertise/private-equity-sponsors/ permanent;
  rewrite ^/syndications  /en/us/we-can-help/finance-growth/ permanent;
  rewrite ^/transportationfinance /en/us/industry-expertise/us-trucking/ permanent;
  rewrite ^/treasury  /en/us/we-can-help/manage-cash-flow/ permanent;
  rewrite ^/treasuryandpayments /en/us/we-can-help/manage-cash-flow/ permanent;
  rewrite ^/treasurymanagement  /en/us/we-can-help/manage-cash-flow/ permanent;
  rewrite ^/trucking  /en/us/industry-expertise/us-trucking/ permanent;
  rewrite ^/wine  /en/us/industry-expertise/food/ permanent;
  rewrite ^/xborder /en/us/we-can-help/doing-business-in-canada/ permanent;
  ###

  #FR Redirect - DHD-18372
  rewrite ^/immobiliercommercial https://entreprises.bmo.com/fr/ca/expertise-sectorielle/immobilier-commercial/ permanent;
  rewrite ^/biensimmobilierscommerciaux https://entreprises.bmo.com/fr/ca/expertise-sectorielle/biens-immobiliers-commerciaux/ permanent;
  rewrite ^/Credit-bailMobilieretFinancement https://entreprises.bmo.com/fr/ca/we-can-help/equipment-financing-leasing/ permanent;
  rewrite ^/financementdefranchise https://entreprises.bmo.com/fr/ca/expertise-sectorielle/financement-de-franchises/ permanent;
  rewrite ^/Financementdefranchises https://entreprises.bmo.com/fr/ca/expertise-sectorielle/financement-de-franchises/ permanent;
  rewrite ^/financementsoinsdesante https://entreprises.bmo.com/fr/ca/expertise-sectorielle/soins-de-sante/ permanent;
  rewrite ^/ServicesProfessionnels https://entreprises.bmo.com/fr/ca/expertise-sectorielle/services-professionnels/ permanent;
  ###  

  #EST noon - 20220916 changes
  rewrite ^/industry-expertise/engineering-construction/\?ecid\=va-DT-9223-SKBMOH22 /en/us/industry-expertise/engineering-construction/ permanent;


  rewrite ^/en/industry-expertise/engineering-construction/?ecid=va-DT-9223-SKBMOH22 /en/ca/industry-expertise/engineering-construction/ permanent;
  rewrite ^/industry-expertise/engineering-construction/?ecid=va-DT-9223-SKBMOH22 /en/us/industry-expertise/engineering-construction/ permanent;

  ## DHD-18452
  rewrite ^/dealer /en/us/industry-expertise/auto-dealerships/ permanent;

  #combined - from CA server
  rewrite ^/en/industry-expertise/commercial-real-estate/ /en/ca/industry-expertise/commercial-real-estate/ permanent;

  ## DHD-18585
  rewrite ^/see-further /en/us/see-further/ permanent;
  
  # 17th sept redirection - Karthik

  ## BCME-142
  ## rewrite ^/cannabis /en/ca/industry-expertise/cannabis-emerging-industries/ permanent;

  ## BCME-154
  rewrite ^/mcdonalds-operators /en/us/industry-expertise/mcdonalds-operators/ permanent;

  location / {
    #add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    # Force cookie rewrite with HttpOnly and secure flag
    proxy_cookie_path / "/; HTTPOnly; Secure";

    location ~* \.(?:manifest|appcache|html?|json)$ {
      add_header Cache-Control "max-age=0";
    }

    location ~* \.(?:rss|atom)$ {
      add_header Cache-Control "max-age=3600";
    }

    location ~* \.(?:jpg|jpeg|gif|png|ico|cur|gz|svg|mp4|ogg|ogv|webm|htc)$ {
      access_log off;
      add_header Cache-Control "max-age=2592000";
    }

    location ~* \.svgz$ {
      access_log off;
      gzip off;
      add_header Cache-Control "max-age=2592000";
    }

    location ~* \.(?:css|js)$ {
      add_header Cache-Control "max-age=31536000";
      access_log off;
    }

    location ~* \.(?:ttf|ttc|otf|eot|woff|woff2)$ {
      add_header Cache-Control "max-age=2592000";
      access_log off;
    }

    if ( $query_string = "edit" ) {
      return 403;
    }

    include /etc/nginx/conf.d/uwsgi_params;
    uwsgi_pass commercial_app_prod_us;
    limit_req zone=commercial_app_prod_us burst=200 nodelay;

  }
}

